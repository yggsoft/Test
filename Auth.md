# 橙讯账户(橙讯统一认证平台)

## 概述

本文档作为用户与该功能需求开发维护人员共同遵守的软件需求规范说明书。

统一认证平台，可提供可靠统一用户登陆、用户认证等功能， 它可以在不改变现有基础结构的情况下， 对现有的系统进行集成， 也能适应各种未知系统的集成。

建立统一认证平台是IT规划的总体目标之一，目的是为了使得现有系统的用户信息重复混乱现状得以改变，也为新规划的系统建立统一的认证标准。

目标

1. 安全地完成对用户和用户终端的认证，账户的全生命周期管理；
2. 账户相关数据的统计。登录时间、次数；
3. 开放账户系统，具备第三方应用支持；

## 认证

### 用户注册

用户注册时需要提交手机号和短信验证码。其中手机号是用户的唯一标识，每个用户的手机号不能重复，但允许用户变更自己的手机号。

流程

1. 用户输入手机号获取验证码，手机号已被注册，给出反馈；手机号码不正确，给出提示；

验证码规则

- 验证码字数限制，6位纯数字
- 验证码错误，弱提示？
- 验证码已被使用，然后给出什么操作呢？
- 验证码已过期，过期了给出弹窗吗？在弹窗直接获取验证码？
- 验证码已达到最大尝试次数，最大是多少次？

老版流程

1. 用户输入手机号，密码，确认密码和验证码，点击注册按钮，开始注册流程；
2. 验证该手机号是否注册，如果该手机号已经注册，提示用户该手机号已经注册（由于存在橙讯认证服务器和统一认证服务器两套服务器数据不一致的情况，有可能出现一个用户在橙讯认证服务器注册但是统一认证服务器未注册的情况，因此需要先判断橙讯服务器该账号是否已经注册）；
3. 生成公私钥等注册信息，调用统一认证服务器注册用户；
4. 根据服务器返回的结果判断是否注册成功（如手机号已经被注册），如注册成功，调用登录接口执行登录操作。

年轮认证流程

1. 移动终端在注册请求前，需要生成加密密钥公钥PK,私钥SK。
2. 密钥对在客户端生成，公钥上传至服务器，用以生成证书，私钥用PIN码进行手势HASH加密上传至服务器（对称加密算法AES）。
3. 提交注册信息时，将密钥对的PK,SK（PIN码HASH加密），用户信息，并对要发送的信息进行签名，一起发送到服务端。服务端对信息进行验证签名，并存储密钥对及用户信息在服务端数据库。将客户端生成的私钥SK的HASH值也上传至服务端，用作用户登录时，解密正确与否的判断
4. 提交注册信息包含：密钥对（PK,SK），用户基本信息（上一章节字段），签名。注意：SK传输时需要做加密处理。
5. 服务端接收到注册请求后，服务端对信息进行验证签名，并存储密钥对及用户信息在服务端数据库。
6. 服务端应答客户端注册结果。
7. 结束。

### 实名认证

实名认证功能提供一项身份识别服务。用户可申请进行实名认证，填写个人真实信息并提交至橙讯用户审核系统验证审核。

用户可以在网站、手机客户端等渠道申请实名认证，提请实名申请的用户，需填写如下信息作为审核依据

- 用户真实姓名
- 证件类型（目前只对证件类型为"身份证"用户开放）
- 证件号码
- 身份证正面扫描/拍照图（注：资料填写不全者，不允许提交实名申请）

  - 用户提交的证件图片，要求如下：

    - 格式：仅支持JPGE格式
    - 图片大小：不超过200k
    - 清晰度要求：证件照片、文字清晰可见，无明显涂改痕迹 （注：不满足以上条件者，实名认证申请失败）

- 除身份证外，其他证件类型不允许提交实名认证；

### 用户登录

用户使用手机号以及密码登录，且手机号是唯一的。

- 当手机号/密码不正确时，提示"登录失败"。

流程

老版流程

1. 用户输入账号密码，点击登录按钮；
2. 调用统一认证服务器登录接口；
3. 处理登录接口返回的数据，有三种情况需要分析：

  1. 用户登录成功（账号密码正确）：

    1. 解析服务器返回的结果，得到私钥hash和私钥密文，本地判断用户密码是否正确；
    2. 使用用户密码解密私钥密文得到私钥mStrSk，并使用mStrSk对手机号加密生成签名数据mSignature；
    3. 调用统一认证服务器"loginOnLine"接口，获取token，id；
    4. 使用token，id作为参数向橙讯服务器获取用户账号信息（id，mqtt_topic,mqtt_password）；
    5. 做登录成功的跳转；

  2. 用户输入的密码不正确，提示用户账号或密码错误；

  3. 该用户未注册，出现用户未注册的情况，需要判断用户输入的账号密码在橙讯服务器是否通过验证，如果通过验证，则需要在统一认证服务器执行一次注册操作，流程如下：

    1. 橙讯服务器验证用户的账号密码是否正确；
    2. 如果用户已注册且密码正确，调用统一认证服务器执行注册流程，否则提示用户账号或密码错误；
    3. 统一认证服务器注册新用户（具体流程参考注册流程）；

### 修改用户信息

用户帐号属性：账户ID 手机号 密码（公私钥，HASH密码) 账户创建时间 最后登录时间

用户属性：姓名 性别 年龄 身份证明 教育背景 职业 荣誉 头像 邮件 所在国家/地区

### 用户登出

### 用户忘记密码

流程

老版流程

用户忘记密码后重置密码的流程相对比较复杂，主要原因是橙讯认证服务器和统一认证服务器存在数据不一致问题；由于安全手机重置密码不需要短信验证码，因此安全手机和非安全手机用户忘记密码后的流程也不一致。下面分安全手机和非安全手机两种情况讨论忘记密码流程。

安全手机

1. 用户输入新密码，点击保存按钮；
2. 统一认证服务器检查该账号是否注册；
3. 如果该账号在统一认证服务器注册，则调用统一认证服务器重置密码接口，否则调用橙讯服务器重置密码接口；
4. 处理返回结果；

非安全手机

1. 输入手机号码，新密码，点击获取验证码；
2. 统一认证服务器检查该账号是否注册；
3. 如果该账号在统一认证服务器注册，则调用统一认证服务器获取短信验证码接口，否则调用橙讯服务器获取短信验证码接口；
4. 用户填写短信验证码，点击保存按钮；
5. 根据该账号是否在统一认证服务器注册，分别调用统一认证服务器重置密码接口或橙讯服务器重置密码接口；
6. 处理返回结果；

### 绑定、解绑

老版流程

1. 用户输入新手机号和验证码提交；
2. 橙讯认证服务器检查新号码的注册情况，如果新号码在橙讯认证服务器已注册，提示用户该号码已经注册，如果没有注册，进行下一步；
3. 统一认证服务器检查新号码是否注册，如果注册了，提示用户，如果没有注册，执行绑定手机号操作；
4. 统一认证服务器更换绑定手机号，执行成功后，再用橙讯认证服务器绑定新手机号；
5. 绑定新号码成功后，更新mqttpassword、用户手机号，重新连接mqtt服务器等操作；

### 用户查询/禁用/冻结

### 用户注销

## 授权

### 二维码扫描

二维码扫码能扫码任意二维码，得到二维码扫码的结果，并解析该二维码。如果该二维码扫描结果以www.cheng-xun.cn开头，并且包含uuid，则处理第三方授权登录，否则直接显示二维码扫描的结果。

三方授权登录

1. 通过uuid拉取本次授权第三方应用的名称等基本信息，等待用户点击确认登录按钮；
2. 用户点击确认登录后，向服务器发出确认授权请求，允许第三方应用登录；

扫码验证成功后，需要返回用户信息到第三方应用服务器。返回用户信息包括但不仅限于以下数据：认证成功/失败，用户名称，用户头像，单位信息，组织信息。

### 用户授权管理

用户授权管理的主要任务是对用户授权进行管理

- 用户基本信息管理 管理员进行个人信息的操作与更新，包括增、删、查、改四个操作。

### 用户授权

### 回收授权

## 个人用户信息管理

向三方商户展示一个二维码，用以扫码后，在商户的客户端展示用户必要信息。二维码用OTP的协议，每一分钟变换，可离线变换，参照支付宝付款二维码。 该页面右上角下拉菜单一、扫码记录，二、使用说明

## 账户统计

- 账户相关数据的统计。登录时间、次数；

## 第三方应用

开发者管理 应用管理 授权管理 更新日志管理 API文档管理 公共管理

### 开发者注册

### 开发者管理

### 应用管理

### 应用审核

### 应用验证授权

## 非功能需求

- 集群高可用 - 统一认证系统要求能够通过配置实现负载均衡群集，从而保证系统的可用性和性能。本系统须提供7*24小时的不间断服务，运行环境部署时要考虑双机热备方案；
- 数据缓存 - 各个应用系统在验证用户信息、权限信息时，数据库访问IO压力很大，为提高效率，应合理使用Cache，如Redis等；
- 维护性 - 系统架构合理，便于系统的维护与扩充；开发代码严格按照编程规约执行，提高代码的可读性；
- 安全性 - 为了系统集成安全，统一认证系统返回凭据信息应加密传输；统一认证系统能够支持SSL;

## 注意事项

- 《移动互联网应用程序信息服务管理规定》，明确自2016年8月1日起，APP注册用户应按照"后台实名、前台自愿"的原则进行实名认证。即用户在注册APP时，应提供真实个人资料，包括经过通信运营商实名认证的手机号码或者银行卡等信息。而网名是否采取实名，则由用户自己决定。这项规定还要求，APP提供者应当严格落实信息安全管理责任，依法履行"六项义务"：一是对注册用户进行真实身份信息认证；二是建立健全用户信息安全保护机制；三是建立健全信息内容审核管理机制，对发布违法违规信息内容的，视情采取警示、限制功能、暂停更新、关闭账号等处置措施；四是依法保障用户知情权和选择权；五是尊重和保护知识产权，不得制作、发布侵犯他人知识产权的应用程序；六是记录用户日志信息，并保存六十日。

- 登录注册，核心的有：

  - 提高登录注册转化率，降低跳出率，辛辛苦苦做活动拉人拉过来，没登录注册就跑
  - 防刷单防马甲防诈骗,平台业务量大起来，特别涉及金额交易的平台，那更要注意了
  - 登录注册流友好通畅，细致至每个提示，当用户是傻瓜对待，而标准是，把每个使用场景与触发事件想清楚，用户进行每个场景操作，想都不用想就知道啥意思 申诉流程足够通畅，不然密码错误了，因流程流程复杂有问题，用户就不陪你玩了（微信公众号的密码申诉流程就是很典型BUG，登录时提示该账号密码不正确，找回密码又提示该账号不存在，注册时又提示该账号已占用，啥玩意呀？）

## 附录A：词汇表

- 统一认证平台：橙讯应用支撑性平台，包括了统一用户、应用资源的管理以及各应用资源的统一认证管理。
- 统一用户管理：负责橙讯全体用户的身份管理，并分配各应用子系统中具有使用权的用户，将统一用户信息同步到应用子系统中。
- 统一认证：负责橙讯统一用户认证以及单点登录支持，用户通过平台统一登录之后可以单点登录访问其权限范围内的各分项应用子系统，单点登录需要各应用系统支持统一认证接口。
- UIA 统一身份认证 (Unified identity authentication)
- SSO 单点登录 (Single sign-on)

--------------------------------------------------------------------------------

# 用户服务管理

## 概述

- 管理所有可用服务；
- 用户等级类别控制，决定用户可用服务；
- 统计用户服务调用，可基于此做服务限制；
- 用户服务中心，用户服务使用情况，明细

备注: 服务 -- 软件即服务，功能、模块即服务；

# 应用系统服务统计（应用内部实现）

## 概述

- 各服务实现精细统计;
- 提供跟业务相关的统计; 例如：发消息数量，打电话数量，云存储空间占用量

--------------------------------------------------------------------------------

# 应用服务统计平台（）

## 概述

- 服务门户，
- 基于《用户服务管理》《应用系统服务统计》统计各服务使用时长、频度 发消息数量，打电话数量，云存储空间占用量等等

<https://wenku.baidu.com/view/660dc565caaedd3383c4d396.html> <http://www.woshipm.com/pd/267274.html> <http://www.wendangku.net/doc/91de94c54b73f242326c5f94-4.html> <http://www.sohu.com/a/140633022_114819> <https://wenku.baidu.com/view/91de94c54b73f242326c5f94.html> <https://wenku.baidu.com/view/88d20aa476a20029bd642dcc.html> <https://wenku.baidu.com/view/871a045577232f60ddcca17d.html?re=view>

<https://www.processon.com/view/58d21014e4b0d1772221fad8> <https://www.processon.com/view/58f0a240e4b0cb4162aede99> <https://www.processon.com/view/58242512e4b064c051ad31c3> <https://www.processon.com/popular?criterion=%E5%BC%80%E6%94%BE%E5%B9%B3%E5%8F%B0>

<https://www.processon.com/view/584fc6eae4b07016a82549f0>

```
Introduction
[Overall Description](Overall Description.md)
[External Interface Requirements](External Interface Requirements.md)
[System Features](System Features.md)
[Other Non-Functional Requirements](Other Non-Functional Requirements.md)
[Other Requirements](Other Requirements.md)
Appendix A: Glossary
[Appendix B: Analysis Models](Appendixes/Analysis Models.md)
[Appendix C: To Be Determined List](Appendixes/To Be Determined List.md)
```
